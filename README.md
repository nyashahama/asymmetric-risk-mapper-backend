# Asymmetric Risk Mapper — Backend

Go backend for a paid, one-shot business risk assessment. Users answer a questionnaire, pay via Stripe, and receive an AI-generated risk report by email.

## Stack

Go 1.23 · chi · PostgreSQL · sqlc · golang-migrate · Stripe · DeepSeek/Anthropic · Resend · Docker

## Getting Started

```bash
cp .env.example .env        # fill in secrets
docker compose up -d db     # start local postgres
migrate -path migrations -database "$DATABASE_URL" up
go run ./cmd/api            # server starts on :8080
```

## Configuration

`.env` is loaded automatically in development. Required variables:

| Variable | Description |
|---|---|
| `DATABASE_URL` | Postgres DSN |
| `STRIPE_SECRET_KEY` | Stripe secret key |
| `STRIPE_WEBHOOK_SECRET` | Stripe webhook signing secret |
| `RESEND_API_KEY` | Resend API key |
| `ANTHROPIC_API_KEY` or `DEEPSEEK_API_KEY` | At least one AI provider required |

Optional: `PORT` (8080), `ENV` (development), `BASE_URL`, `WORKER_COUNT` (3), `POLL_INTERVAL` (30s), `JOB_TIMEOUT` (5m), `MAX_RETRIES` (3), model name overrides.

If both AI keys are set, DeepSeek is primary with Anthropic as the automatic fallback.

> **Supabase note:** use the transaction pooler URL (port `6543`). The direct connection (port `5432`) resolves to IPv6 which may be unreachable on some networks.

## Database

```bash
migrate -path migrations -database "$DATABASE_URL" up      # apply
migrate -path migrations -database "$DATABASE_URL" down 1  # rollback
sqlc generate                                               # regenerate internal/db/ after editing sql/
```

Never edit `internal/db/` directly — it is generated by sqlc.

## API

All session routes require the `X-Anon-Token` header returned on session creation.

| Method | Path | Description |
|---|---|---|
| `POST` | `/api/session` | Create anonymous session → `{session_id, anon_token}` |
| `PATCH` | `/api/session/:id/context` | Update business context |
| `PUT` | `/api/session/:id/answers` | Batch upsert answers (idempotent) |
| `POST` | `/api/session/:id/checkout` | Create Stripe PaymentIntent → `{client_secret}` |
| `POST` | `/api/webhooks/stripe` | Stripe webhook receiver |
| `GET` | `/api/report/:token` | Fetch report (202 while generating, 200 when ready) |

## Tests

```bash
go test ./...                   # all tests
go test ./internal/scoring/...  # unit tests (no DB needed)
go test ./internal/store/...    # integration tests (needs DATABASE_URL)
go test -race ./...             # with race detector
```

## Docker

```bash
docker compose up --build  # full stack (postgres on :5433, api on :8080)
docker compose up -d db    # postgres only — run api natively with go run
```

## Deployment

Deploy anywhere that runs Docker. Set environment variables on the platform and point Stripe webhooks at `https://your-domain.com/api/webhooks/stripe`.

```bash
stripe listen --forward-to localhost:8080/api/webhooks/stripe  # local webhook testing
```
